<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Facturas - Cl√≠nica Salus</title>
    <!-- Cargamos Tailwind CSS para un estilo moderno y responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Fuente Inter para mejor legibilidad */
        :root {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body class="bg-gray-50 p-4 md:p-8 min-h-screen">

    <div class="max-w-7xl mx-auto">
        <header class="mb-8">
            <h1 class="text-3xl font-extrabold text-blue-800 tracking-tight">
                Gesti√≥n de Facturas (ADMIN/CONTADOR)
            </h1>
            <p class="text-gray-600 mt-1">CRUD de Facturas: Para operaciones, la API requiere el puerto 3000 abierto y
                un Token de Autenticaci√≥n v√°lido.</p>
        </header>

        <!-- Secci√≥n de Autenticaci√≥n (Token) -->
        <section class="bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">üîë Token de Sesi√≥n</h2>
            <div class="flex flex-col sm:flex-row gap-3">
                <input type="text" id="apiToken"
                    placeholder="Pegue el Token obtenido en Postman aqu√≠ (ej: 2|sdjhgfu7...)"
                    class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                <button onclick="guardarYcargarFacturas()" id="btnCargar"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150">
                    Guardar Token y Cargar
                </button>
            </div>
            <p id="tokenStatus" class="mt-2 text-sm font-medium"></p>
        </section>

        <!-- Botones de Acci√≥n CRUD -->
        <section class="mb-8 p-6 bg-white rounded-lg shadow-md">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Acciones (CRUD)</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button onclick="abrirModal('modalInsertar')"
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150">
                    + Insertar Nueva Factura
                </button>
                <button onclick="simularActualizar()"
                    class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150">
                    Actualizar Factura (Ej.)
                </button>
                <button onclick="simularEliminar()"
                    class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-150">
                    Eliminar Factura (Ej.)
                </button>
            </div>
        </section>


        <!-- Secci√≥n de Listado de Facturas (READ) -->
        <section class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Lista de Facturas</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                C√≥d.</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Cliente</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Fecha</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Total</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Estado</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaFacturas" class="bg-white divide-y divide-gray-200">
                        <!-- Las facturas se insertar√°n aqu√≠ por JavaScript -->
                        <tr>
                            <td colspan="6" class="p-4 text-center text-gray-500">
                                Presione "Guardar Token y Cargar". (Esperando respuesta de Interserver...)
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <p id="mensajeError" class="text-red-500 mt-4 hidden"></p>
        </section>
    </div>

    <!-- Modal para Mensajes/Formularios (Reemplazo de alert()) -->
    <div id="customModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4"
        onclick="cerrarModalExterno(event)">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full" id="modalContent">
            <h3 class="text-lg font-bold mb-4" id="modalTitle">Mensaje</h3>
            <p id="modalBody" class="mb-6"></p>
            <div class="flex justify-end">
                <button onclick="cerrarModal()"
                    class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Cerrar</button>
            </div>
        </div>
    </div>


    <script>
        // La IP de tu servidor y puerto de la API
        const API_BASE_URL = 'http://208.73.203.238:3000/api/factura'; // Asumo la ruta '/api/factura' para el CRUD
        const TOKEN_STORAGE_KEY = 'clinicaSalusApiToken'; // Clave para localStorage

        // Referencias del DOM
        const tablaFacturas = document.getElementById('tablaFacturas');
        const apiTokenInput = document.getElementById('apiToken');
        const tokenStatus = document.getElementById('tokenStatus');
        const mensajeError = document.getElementById('mensajeError');
        const modal = document.getElementById('customModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');

        // Funci√≥n auxiliar para mostrar mensajes personalizados (reemplazo de alert())
        function mostrarMensaje(titulo, cuerpo, tipo = 'info') {
            modalTitle.textContent = titulo;
            modalBody.textContent = cuerpo;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            // Opcional: cambiar color de t√≠tulo basado en tipo
            modalTitle.className = 'text-lg font-bold mb-4 ' + (tipo === 'error' ? 'text-red-600' : 'text-blue-600');
        }

        function cerrarModal() {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        // Cierra el modal solo si se hace clic fuera del contenido
        function cerrarModalExterno(event) {
            if (event.target.id === 'customModal') {
                cerrarModal();
            }
        }

        function actualizarEstadoToken(esValido, mensaje) {
            tokenStatus.textContent = mensaje;
            tokenStatus.className = 'mt-2 text-sm font-medium ' + (esValido ? 'text-green-600' : 'text-red-600');
        }

        function getToken() {
            // 1. Intentar obtener del input (si el usuario lo peg√≥)
            let token = apiTokenInput.value.trim();
            if (token) {
                // Si el usuario lo peg√≥, lo guardamos para futuras recargas
                localStorage.setItem(TOKEN_STORAGE_KEY, token);
                return token;
            }

            // 2. Intentar obtener del almacenamiento local (token de sesi√≥n anterior)
            token = localStorage.getItem(TOKEN_STORAGE_KEY);
            if (token) {
                // Si lo encontramos en el storage, lo mostramos en el input por conveniencia
                apiTokenInput.value = token;
                return token;
            }
            return null;
        }

        function guardarYcargarFacturas() {
            const tokenIngresado = apiTokenInput.value.trim();
            if (tokenIngresado) {
                localStorage.setItem(TOKEN_STORAGE_KEY, tokenIngresado);
                cargarFacturas(tokenIngresado);
            } else {
                cargarFacturas(); // Intentar√° cargar con el token que ya est√© guardado
            }
        }


        // =========================================================
        // 1. CARGAR/SELECCIONAR FACTURAS (READ)
        // =========================================================

        async function cargarFacturas(tokenOverride = null) {
            const token = tokenOverride || getToken(); // Usar el token reci√©n ingresado o el guardado

            tablaFacturas.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-blue-500">Cargando facturas...</td></tr>';
            mensajeError.classList.add('hidden');

            if (!token) {
                actualizarEstadoToken(false, "‚ùå Error: Debe ingresar el Token de Autenticaci√≥n.");
                tablaFacturas.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-red-500">Token no proporcionado.</td></tr>';
                return;
            }

            try {
                // Endpoint SELECT: /api/factura/mostrar (asumido basado en tus procedimientos)
                const response = await fetch(`${API_BASE_URL}/mostrar`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`, // Env√≠a el Token de seguridad
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 200) {
                    const data = await response.json();
                    actualizarEstadoToken(true, "‚úÖ Conexi√≥n Exitosa. Token Aceptado.");
                    renderizarFacturas(data);
                } else if (response.status === 401 || response.status === 403) {
                    // 401: No autorizado (Token inv√°lido o expirado)
                    // 403: Prohibido (Token v√°lido, pero el rol no tiene permisos)
                    const error = await response.json();
                    actualizarEstadoToken(false, `‚ùå Error de Autorizaci√≥n (${response.status}): ${error.message || 'Token inv√°lido o sin permisos.'}`);
                    tablaFacturas.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-red-500">Acceso denegado. Revise su Token y Rol.</td></tr>';
                } else {
                    const errorText = await response.text();
                    throw new Error(`Error en la API (${response.status}): ${errorText.substring(0, 100)}...`);
                }

            } catch (error) {
                // ESTE ES EL ERROR CR√çTICO (ETIMEDOUT) que esperamos que Interserver resuelva
                if (error.message.includes('Failed to fetch') || error.message.includes('ETIMEDOUT')) {
                    const errorMsg = 'üõë ERROR DE CONEXI√ìN: No se puede acceder a ' + API_BASE_URL + '. El puerto 3000 sigue bloqueado o el servidor est√° inactivo. (ETIMEDOUT)';
                    mostrarMensaje('Error Cr√≠tico de Red', errorMsg, 'error');
                    actualizarEstadoToken(false, errorMsg);
                    tablaFacturas.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-red-600 font-bold">' + errorMsg + '</td></tr>';
                } else {
                    mostrarMensaje('Error Inesperado', error.message, 'error');
                    actualizarEstadoToken(false, `‚ùå Error: ${error.message}`);
                    tablaFacturas.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-red-500">Error: ' + error.message + '</td></tr>';
                }
            }
        }

        function renderizarFacturas(facturas) {
            tablaFacturas.innerHTML = ''; // Limpia la tabla
            if (facturas.length === 0) {
                tablaFacturas.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">No hay facturas registradas.</td></tr>';
                return;
            }

            facturas.forEach(factura => {
                const row = tablaFacturas.insertRow();
                const total = parseFloat(factura.Total_Factura).toFixed(2);
                const estado = factura.Estado_Pago || 'Pendiente';

                // Asumo que tu API devuelve Nombre_Cliente y Apellido_Cliente o solo DNI
                const nombreCliente = factura.Nombre_Cliente ? `${factura.Nombre_Cliente} ${factura.Apellido_Cliente}` : `Cliente #${factura.Cod_Cliente}`;
                const fecha = new Date(factura.Fecha_Factura).toLocaleDateString('es-ES');

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${factura.Cod_Factura}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${nombreCliente}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${fecha}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 font-bold">$${total}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${estado === 'Pagado' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                            ${estado}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="abrirModal('modalActualizar', ${factura.Cod_Factura})" class="text-indigo-600 hover:text-indigo-900 text-sm mr-2">Editar</button>
                        <button onclick="eliminarFactura(${factura.Cod_Factura})" class="text-red-600 hover:text-red-900 text-sm">Eliminar</button>
                    </td>
                `;
            });
        }


        // =========================================================
        // 2. SIMULACIONES CRUD (UPDATE, DELETE, INSERT)
        // Se necesitan las rutas espec√≠ficas en tu Node.js (ej: /api/factura/insertar)
        // =========================================================

        function abrirModal(tipo, codFactura = null) {
            // Esta funci√≥n abrir√≠a un formulario real para INSERTAR/ACTUALIZAR
            let titulo = 'Formulario de Factura';
            let cuerpo = `Funci√≥n ${tipo.replace('modal', '')} (Cod: ${codFactura || 'Nuevo'}). La l√≥gica del formulario va aqu√≠.`;
            mostrarMensaje(titulo, cuerpo);
        }

        async function simularActualizar() {
            // Ejemplo de llamada a la API para UPDATE
            mostrarMensaje('Simulaci√≥n', 'Se intentar√° enviar una petici√≥n PUT para actualizar la factura 123.');
            // Aqu√≠ ir√≠a la llamada a fetch con m√©todo 'PUT'
        }

        async function simularEliminar() {
            // Ejemplo de llamada a la API para DELETE
            mostrarMensaje('Simulaci√≥n', 'Se intentar√° enviar una petici√≥n DELETE para la factura 456.');
            // Aqu√≠ ir√≠a la llamada a fetch con m√©todo 'DELETE'
        }

        async function eliminarFactura(codFactura) {
            const token = getToken(); // Obtener el token del storage
            if (!token) {
                mostrarMensaje('Error', 'Necesita un token v√°lido para eliminar.', 'error');
                return;
            }

            if (!window.confirm(`¬øEst√° seguro de que desea eliminar la Factura #${codFactura}? Esta acci√≥n es permanente.`)) {
                return;
            }

            try {
                // Endpoint DELETE: /api/factura/eliminar?cod=X (asumido)
                const response = await fetch(`${API_BASE_URL}/eliminar?cod=${codFactura}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 200) {
                    mostrarMensaje('√âxito', `Factura #${codFactura} eliminada correctamente. Recargando lista.`);
                    cargarFacturas(); // Recargar la lista despu√©s de la eliminaci√≥n
                } else {
                    // Intentamos leer el error como JSON, si no, como texto
                    const errorData = await response.json().catch(() => ({ message: 'Error de respuesta del servidor.' }));
                    throw new Error(`Error (${response.status}): ${errorData.message || 'No se pudo eliminar.'}`);
                }
            } catch (error) {
                mostrarMensaje('Error de Eliminaci√≥n', error.message, 'error');
            }
        }

        // Carga inicial: intenta cargar el token guardado
        document.addEventListener('DOMContentLoaded', () => {
            const savedToken = localStorage.getItem(TOKEN_STORAGE_KEY);
            if (savedToken) {
                apiTokenInput.value = savedToken; // Muestra el token guardado
                actualizarEstadoToken(false, "Token encontrado. Presione 'Guardar Token y Cargar'.");
            } else {
                actualizarEstadoToken(false, "Esperando Token y confirmaci√≥n de Interserver (Puerto 3000)");
            }
        });

    </script>
</body>

</html>